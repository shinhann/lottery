<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æ´»å‹•æ‘¸å½©ç³»çµ±</title>
    <!-- åŒ¯å…¥ Confetti ç‰¹æ•ˆåº« (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- åŒ¯å…¥ html2canvas æˆªåœ–åº« (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --main-bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-color: #3b82f6;
            --text-color: #1f2937;
            --accent-color: #ef4444;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        header {
            text-align: center;
            padding: 1rem;
            position: relative;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
            flex-shrink: 0;
            border-radius: 0 0 16px 16px;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-color);
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
        }

        .settings-btn {
            position: absolute;
            top: 50%;
            right: 1.5rem;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.8rem;
            opacity: 0.7;
            transition: 0.3s;
        }
        .settings-btn:hover { opacity: 1; transform: translateY(-50%) rotate(90deg); }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- æŠ½çä¸»èˆå° --- */
        .stage {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 2rem;
            text-align: center;
            width: 90%;
            max-width: 800px;
            margin-bottom: 2rem;
            border: 3px solid var(--primary-color);
            transition: all 0.3s;
            position: relative;
        }

        .current-prize-info {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            font-weight: bold;
        }
        .current-prize-info span { color: var(--accent-color); }

        .rolling-display {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: bold;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(248, 250, 252, 0.9); /* ç¨å¾®é€æ˜ */
            border-radius: 10px;
            margin: 1.5rem 0;
            overflow: hidden;
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            border: 1px dashed #cbd5e1;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-bonus { background-color: #f59e0b; color: white; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3); }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: var(--accent-color); color: white; }
        .btn-info { background-color: #0ea5e9; color: white; }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            width: 90%;
            max-width: 1000px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* --- ä¸­çåå–®å€ --- */
        .winners-section {
            width: 90%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding-bottom: 2rem;
        }

        .prize-group {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 5px solid var(--primary-color);
            animation: fadeIn 0.5s ease;
        }

        .prize-group h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            color: var(--text-color);
        }

        .winner-list { list-style: none; padding: 0; margin: 0; }

        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            color: var(--text-color);
        }
        .winner-item:last-child { border-bottom: none; }

        .winner-name { font-size: 1.2rem; font-weight: 600; }
        
        .redraw-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            color: #6b7280;
            padding: 6px;
            border-radius: 50%;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .redraw-btn:hover { background-color: #fee2e2; color: #ef4444; border-color: #fecaca; }
        .redraw-btn svg { width: 20px; height: 20px; }

        /* --- Modal (é€šç”¨) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            color: #1f2937; /* Modal å›ºå®šæ·ºè‰²èƒŒæ™¯ï¼Œæ–‡å­—æ·±è‰² */
        }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .close-modal {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            color: #1f2937;
        }

        /* --- Tabs è¨­è¨ˆ --- */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 0 1.5rem;
        }
        .tab-btn {
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
            transition: 0.2s;
            border-radius: 0;
        }
        .tab-btn:hover { color: var(--primary-color); }
        .tab-btn.active { border-bottom-color: var(--primary-color); color: var(--primary-color); background: #fff; border-radius: 8px 8px 0 0; }
        
        .tab-content { display: none; padding-top: 1rem; }
        .tab-content.active { display: block; }

        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .form-control:focus { outline: none; border-color: var(--primary-color); ring: 2px var(--primary-color); }
        
        .prize-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .prize-row input[type="text"] { flex: 8; }
        .prize-row input[type="number"] { flex: 2; }
        
        .btn-icon { 
            padding: 8px 12px; 
            border-radius: 4px; 
            background: #fee2e2; 
            color: #ef4444; 
            border: none; 
            cursor: pointer;
            flex-shrink: 0; 
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .btn-icon:hover { background: #fecaca; }

        /* ä¸»é¡ŒæŒ‰éˆ•ç¶²æ ¼ */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .theme-btn {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .theme-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .theme-btn.active { border-color: var(--primary-color); background: #eff6ff; }
        
        .color-preview {
            width: 100%;
            height: 40px;
            border-radius: 6px;
            border: 1px solid #ddd;
            display: flex;
            overflow: hidden;
        }
        .color-preview div { flex: 1; height: 100%; }

        .help-box {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #1e40af;
            margin-top: 10px;
            line-height: 1.5;
        }
        .help-box ol { margin: 0.5rem 0 0 1.2rem; padding: 0; }

        /* RWD */
        @media (max-width: 600px) {
            .tabs { flex-direction: column; padding: 0; }
            .tab-btn { width: 100%; text-align: left; border-bottom: 1px solid #eee; }
            .tab-btn.active { border-bottom: 3px solid var(--primary-color); border-radius: 0; }
            .controls { flex-direction: column; }
            button { width: 100%; justify-content: center; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- éŸ³æ•ˆå€ -->
<audio id="rolling-sound" src="https://hsuliang.github.io/rool5.mp3" preload="auto" loop></audio>
<audio id="winner-sound" src="https://hsuliang.github.io/happy.mp3" preload="auto"></audio>

<header>
    <h1 id="main-title">å¹´åº¦æ´»å‹•æ‘¸å½©å¤§æœƒ</h1>
    <button class="settings-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
</header>

<div class="container" id="capture-area">
    <!-- æŠ½çèˆå° -->
    <div class="stage" id="main-stage">
        <div class="current-prize-info" id="current-prize-display">æº–å‚™ä¸­...</div>
        <div class="rolling-display" id="rolling-box">ç­‰å¾…é–‹å§‹</div>
        
        <div class="controls" data-html2canvas-ignore>
            <button id="btn-draw-one" class="btn-primary" onclick="startDraw('one')">
                <span>ğŸ²</span> é€ä¸€é–‹ç
            </button>
            <button id="btn-draw-all" class="btn-secondary" onclick="startDraw('all')">
                <span>ğŸš€</span> ä¸€æ¬¡æŠ½å®Œæœ¬çé …
            </button>
            <button id="btn-bonus" class="btn-bonus" onclick="openBonusModal()">
                <span>ğŸ</span> è‡¨æ™‚åŠ ç¢¼
            </button>
        </div>
        <div style="margin-top: 15px; color: #6b7280; font-size: 0.9rem;">
            å‰©é¤˜åå–®äººæ•¸: <span id="pool-count" style="font-weight:bold; color:var(--primary-color);">0</span> äºº
        </div>
    </div>

    <!-- å·¥å…·åˆ— -->
    <div class="toolbar" data-html2canvas-ignore>
        <button class="btn-info" onclick="saveScreenshot()">
            ğŸ“¸ æˆªåœ–å­˜æª”
        </button>
        <button class="btn-success" onclick="exportCSV()">
            ğŸ“Š åŒ¯å‡º CSV
        </button>
    </div>

    <!-- ä¸­çåå–®å±•ç¤ºå€ -->
    <div class="winners-section" id="winners-container">
        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
    </div>
</div>

<!-- ================= è¨­å®šé¢æ¿ (Modal) ================= -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>âš™ï¸ è¨­å®šèˆ‡ç®¡ç†</h2>
            <button class="close-modal" onclick="closeSettings()">âœ•</button>
        </div>
        
        <!-- Tabs å°èˆª -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-list')">åå–®è¨­å®š</button>
            <button class="tab-btn" onclick="switchTab('tab-prizes')">çé …è¨­å®š</button>
            <button class="tab-btn" onclick="switchTab('tab-appearance')">å¤–è§€èˆ‡éŸ³æ•ˆ</button>
            <button class="tab-btn" onclick="switchTab('tab-template')">ç¯„æœ¬å­˜å–</button>
        </div>

        <div class="modal-body">
            <!-- Tab 1: åå–®è¨­å®š -->
            <div id="tab-list" class="tab-content active">
                <div class="form-group">
                    <label>è«‹é¸æ“‡åŒ¯å…¥æ–¹å¼ï¼š</label>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <button class="btn-secondary" style="flex:1;" onclick="showSubMode('manual')">A. è‡ªè¨‚åå–®</button>
                        <button class="btn-secondary" style="flex:1;" onclick="showSubMode('sheet-link')">B. å…±ç”¨é€£çµ</button>
                        <button class="btn-secondary" style="flex:1;" onclick="showSubMode('csv-link')">C. é›²ç«¯åå–®</button>
                    </div>

                    <!-- Mode A: æ‰‹å‹• -->
                    <div id="mode-manual" class="import-mode">
                        <textarea id="names-input" class="form-control" rows="8" placeholder="è«‹ç›´æ¥è²¼ä¸Šå§“å&#10;ç‹å°æ˜, æå¤§åŒ&#10;å¼µä¸‰&#10;æå››"></textarea>
                        <p style="color:#666; font-size:0.9rem; margin-top:5px;">ğŸ’¡ æ”¯æ´é€—è™Ÿ (,) æˆ–æ›è¡Œåˆ†éš”ã€‚</p>
                        <button class="btn-primary" onclick="processManualNames()" style="width:100%;">æª¢æŸ¥ä¸¦å„²å­˜åå–®</button>
                    </div>

                    <!-- Mode B: å…±ç”¨é€£çµ -->
                    <div id="mode-sheet-link" class="import-mode" style="display:none;">
                        <label>1. Google è©¦ç®—è¡¨å…±ç”¨ç¶²å€</label>
                        <input type="text" id="sheet-url-b" class="form-control" placeholder="https://docs.google.com/spreadsheets/d/..." style="margin-bottom:10px;">
                        
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <div style="flex:1;">
                                <label>2. å·¥ä½œè¡¨åç¨±</label>
                                <input type="text" id="sheet-name-b" class="form-control" value="å·¥ä½œè¡¨1">
                            </div>
                            <div style="flex:1;">
                                <label>3. åå–®æ¬„ä½åç¨±</label>
                                <input type="text" id="col-name-b" class="form-control" value="å§“å">
                            </div>
                        </div>
                        <button class="btn-primary" onclick="importFromSheet('shared')" style="width:100%;">åŒ¯å…¥åå–®</button>
                    </div>

                    <!-- Mode C: CSV é€£çµ -->
                    <div id="mode-csv-link" class="import-mode" style="display:none;">
                        <label>ç™¼å¸ƒåˆ°ç¶²è·¯çš„ CSV ç¶²å€</label>
                        <input type="text" id="sheet-url-c" class="form-control" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?output=csv" style="margin-bottom:10px;">
                        
                        <label>åå–®æ¬„ä½åç¨±</label>
                        <input type="text" id="col-name-c" class="form-control" value="å§“å" style="margin-bottom:10px;">
                        
                        <button class="btn-primary" onclick="importFromSheet('csv')" style="width:100%;">åŒ¯å…¥åå–®</button>

                        <div class="help-box">
                            <strong>ğŸ“š å¦‚ä½•å–å¾—ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€çš„ CSV ç¶²å€ï¼Ÿ</strong>
                            <ol>
                                <li>é»æ“Šè©¦ç®—è¡¨å·¦ä¸Šè§’ï¼š<strong>æª”æ¡ˆ > åˆ†äº« > ç™¼å¸ƒåˆ°ç¶²è·¯</strong>ã€‚</li>
                                <li>ç¢ºèªé¸æ“‡ã€Œé€£çµã€åˆ†é ã€‚</li>
                                <li>é¸æ“‡æ‚¨çš„åå–®æ‰€åœ¨ã€Œå·¥ä½œè¡¨ã€ã€‚</li>
                                <li>å°‡æ ¼å¼æ”¹ç‚ºã€Œ<strong>é€—è™Ÿåˆ†éš” (.csv)</strong>ã€ã€‚</li>
                                <li>é»æ“Šã€Œç™¼å¸ƒã€ï¼Œè¤‡è£½ç”¢ç”Ÿçš„ç¶²å€è²¼ä¸Šå³å¯ã€‚</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: çé …è¨­å®š -->
            <div id="tab-prizes" class="tab-content">
                <div class="form-group">
                    <label>çé …åˆ—è¡¨ (æ‹–æ›³æ’åºåŠŸèƒ½æš«ç•¥ï¼Œè«‹ä¾é †åºè¼¸å…¥)</label>
                    <div id="prize-list-settings"></div>
                    <button class="btn-success" onclick="addPrizeInputRow()" style="margin-top:10px;">+ æ–°å¢çé …</button>
                </div>
            </div>

            <!-- Tab 3: å¤–è§€èˆ‡éŸ³æ•ˆ -->
            <div id="tab-appearance" class="tab-content">
                
                <div class="form-group">
                    <label>æ´»å‹•ä¸»æ¨™é¡Œ</label>
                    <input type="text" id="setting-title" class="form-control" value="å¹´åº¦æ´»å‹•æ‘¸å½©å¤§æœƒ" oninput="updateUI()">
                </div>

                <div class="form-group">
                    <label>é è¨­ä¸»é¡Œé…ç½® (é»é¸å¥—ç”¨)</label>
                    <div class="theme-grid">
                        <div class="theme-btn active" onclick="applyTheme(0, this)">
                            <div class="color-preview">
                                <div style="background:#f0f2f5"></div>
                                <div style="background:#3b82f6"></div>
                            </div>
                            <span>ç¶“å…¸è—ç™½</span>
                        </div>
                        <div class="theme-btn" onclick="applyTheme(1, this)">
                            <div class="color-preview">
                                <div style="background:#fff1f2"></div>
                                <div style="background:#e11d48"></div>
                            </div>
                            <span>å–œæ°£æ´‹æ´‹</span>
                        </div>
                        <div class="theme-btn" onclick="applyTheme(2, this)">
                            <div class="color-preview">
                                <div style="background:#0f172a"></div>
                                <div style="background:#fbbf24"></div>
                            </div>
                            <span>æš—å¤œé‡‘çˆµ</span>
                        </div>
                        <div class="theme-btn" onclick="applyTheme(3, this)">
                            <div class="color-preview">
                                <div style="background:#f0fdf4"></div>
                                <div style="background:#16a34a"></div>
                            </div>
                            <span>æ¸…æ–°æ£®æ—</span>
                        </div>
                        <div class="theme-btn" onclick="applyTheme(4, this)">
                            <div class="color-preview">
                                <div style="background:#faf5ff"></div>
                                <div style="background:#9333ea"></div>
                            </div>
                            <span>ç¥ç§˜å¹»ç´«</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>è‡ªè¨‚é…è‰² (é¸æ“‡ä¸Šæ–¹ä¸»é¡Œå¾Œå¯å†å¾®èª¿)</label>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div>
                            <span style="font-size:0.9rem; color:#666; display:block; margin-bottom:5px;">èƒŒæ™¯åº•è‰²</span>
                            <input type="color" id="setting-bg-color" value="#f0f2f5" oninput="updateUI()" style="width:80px; height:40px;">
                        </div>
                        <div>
                            <span style="font-size:0.9rem; color:#666; display:block; margin-bottom:5px;">æŒ‰éˆ•ä¸»è‰²</span>
                            <input type="color" id="setting-main-color" value="#3b82f6" oninput="updateUI()" style="width:80px; height:40px;">
                        </div>
                        <div>
                            <span style="font-size:0.9rem; color:#666; display:block; margin-bottom:5px;">æ–‡å­—é¡è‰²</span>
                            <input type="color" id="setting-text-color" value="#1f2937" oninput="updateUI()" style="width:80px; height:40px;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>èƒŒæ™¯åœ–ç‰‡è¨­å®š</label>
                    <input type="file" id="bg-upload" accept="image/*" class="form-control" onchange="handleImageUpload(event)">
                    <p style="color:#666; font-size:0.85rem; margin-top:5px;">
                        ğŸ’¡ å»ºè­°å°ºå¯¸ï¼š1920x1080 (æ¡Œé¢ç‰ˆ)ï¼Œæª”æ¡ˆå¤§å°å»ºè­°å°æ–¼ 2MBã€‚åœ–ç‰‡å°‡æœƒè¦†è“‹èƒŒæ™¯é¡è‰²ã€‚
                    </p>
                    <button class="btn-secondary" onclick="clearBgImage()" style="margin-top:5px; padding:6px 12px; font-size:0.9rem;">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯åœ–ç‰‡</button>
                </div>

                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="setting-sound" checked style="width:20px; height:20px;">
                        å•Ÿç”¨éŸ³æ•ˆ (æŠ½çèˆ‡ä¸­çè²)
                    </label>
                </div>
            </div>

            <!-- Tab 4: ç¯„æœ¬å­˜å– -->
            <div id="tab-template" class="tab-content">
                <p>æ‚¨å¯ä»¥å°‡ç›®å‰çš„ã€Œæ¨™é¡Œã€çé …ã€å¤–è§€ã€è¨­å®šå„²å­˜èµ·ä¾†ï¼Œä¸‹æ¬¡é–‹å•Ÿæ™‚ç›´æ¥è¼‰å…¥ã€‚</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜ç›®å‰è¨­å®šç‚ºç¯„æœ¬</button>
                    <button class="btn-secondary" onclick="loadTemplate()">ğŸ“‚ è¼‰å…¥ä¸Šæ¬¡ç¯„æœ¬</button>
                    <button class="btn-danger" onclick="clearTemplate()">ğŸ—‘ï¸ æ¸…é™¤ç¯„æœ¬</button>
                </div>
                <p id="template-msg" style="margin-top:10px; color:green;"></p>
                <p style="font-size:0.85rem; color:#666;">æ³¨æ„ï¼šèƒŒæ™¯åœ–ç‰‡å› æª”æ¡ˆè¼ƒå¤§ï¼Œä¸æœƒå„²å­˜åœ¨ç¯„æœ¬ä¸­ã€‚</p>
            </div>
        </div>
    </div>
</div>

<!-- åŠ ç¢¼ Modal -->
<div class="modal" id="bonus-modal">
    <div class="modal-content" style="max-width: 400px; overflow: visible;">
        <div class="modal-header">
            <h2>ğŸ è‡¨æ™‚åŠ ç¢¼</h2>
            <button class="close-modal" onclick="closeBonusModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>åŠ ç¢¼çé …åç¨±</label>
                <input type="text" id="bonus-name" class="form-control" value="ç¸½ç¶“ç†ç´…åŒ…">
            </div>
            <div class="form-group">
                <label>æ•¸é‡</label>
                <input type="number" id="bonus-count" class="form-control" value="1" min="1">
            </div>
            <button class="btn-bonus" style="width: 100%;" onclick="confirmBonus()">ç¢ºèªåŠ ç¢¼ä¸¦å„ªå…ˆæŠ½å‡º</button>
        </div>
    </div>
</div>

<!-- ç³»çµ±é€šç”¨æç¤º Modal (å–ä»£åŸç”Ÿçš„ alert/confirm) -->
<div class="modal" id="system-dialog">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 id="sys-dialog-title">æç¤º</h3>
            <button class="close-modal" onclick="closeSystemDialog()">âœ•</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p id="sys-dialog-msg" style="margin-bottom: 20px; font-size: 1.1rem; color: #333;"></p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-secondary" id="sys-btn-cancel" onclick="closeSystemDialog()">å–æ¶ˆ</button>
                <button class="btn-primary" id="sys-btn-confirm">ç¢ºå®š</button>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * ç¨‹å¼æ ¸å¿ƒé‚è¼¯
     */

    // --- å…¨åŸŸç‹€æ…‹ ---
    let state = {
        title: "å¹´åº¦æ´»å‹•æ‘¸å½©å¤§æœƒ",
        prizes: [
            { name: "ä¸‰ç", count: 10, winners: [] },
            { name: "äºŒç", count: 5, winners: [] },
            { name: "é¦–ç", count: 1, winners: [] }
        ],
        namePool: [], // å°šæœªä¸­çåå–®
        currentPrizeIndex: 0, 
        isRolling: false,
        soundEnabled: true,
        colors: {
            bg: "#f0f2f5",
            primary: "#3b82f6",
            text: "#1f2937",
            card: "#ffffff"
        }
    };

    const audioRoll = document.getElementById('rolling-sound');
    const audioWin = document.getElementById('winner-sound');
    let rollInterval;

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        const saved = localStorage.getItem('luckyDrawTemplate');
        if (saved) {
            // è‡ªå‹•è¼‰å…¥è¨­å®šï¼Œä¸æ‰“æ“¾ä½¿ç”¨è€…
        }
        
        updateUI();
        renderPrizeInputs();
        updateStageInfo();
        
        switchTab('tab-list');
    };

    // --- ç³»çµ±å°è©±æ¡†åŠŸèƒ½ (å–ä»£ alert/confirm) ---
    function showDialog(title, msg, showCancel, callback) {
        document.getElementById('sys-dialog-title').innerText = title;
        document.getElementById('sys-dialog-msg').innerText = msg;
        
        const btnCancel = document.getElementById('sys-btn-cancel');
        const btnConfirm = document.getElementById('sys-btn-confirm');
        
        btnCancel.style.display = showCancel ? 'block' : 'none';
        
        // ç§»é™¤èˆŠçš„ event listenerï¼Œé¿å…é‡è¤‡ç¶å®š
        const newBtn = btnConfirm.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
        
        newBtn.onclick = function() {
            closeSystemDialog();
            if (callback) callback();
        };

        // å¦‚æœåªæ˜¯æ™®é€š alert (æ²’æœ‰ callback ä¸”æ²’æœ‰ cancel)ï¼Œç¢ºèªéµåŠŸèƒ½ç‚ºé—œé–‰
        if (!callback && !showCancel) {
             newBtn.onclick = closeSystemDialog;
        }

        document.getElementById('system-dialog').classList.add('active');
    }

    function closeSystemDialog() {
        document.getElementById('system-dialog').classList.remove('active');
    }

    // å°è£æˆé¡ä¼¼åŸç”Ÿçš„ä»‹é¢
    function showAlert(msg) {
        showDialog("æç¤º", msg, false, null);
    }
    
    function showConfirm(msg, callback) {
        showDialog("ç¢ºèª", msg, true, callback);
    }


    // --- UI æ§åˆ¶ ---
    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
        renderPrizeInputs();
    }
    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('active');
        parsePrizeInputs();
        updateStageInfo();
        renderWinnersArea();
    }

    // ä¸»é¡Œè¨­å®šå®šç¾©
    const themes = [
        { name: "ç¶“å…¸è—ç™½", bg: "#f0f2f5", primary: "#3b82f6", text: "#1f2937", card: "#ffffff" },
        { name: "å–œæ°£æ´‹æ´‹", bg: "#fff1f2", primary: "#e11d48", text: "#881337", card: "#ffffff" },
        { name: "æš—å¤œé‡‘çˆµ", bg: "#0f172a", primary: "#fbbf24", text: "#f1f5f9", card: "#1e293b" }, // æ·±è‰²æ¨¡å¼
        { name: "æ¸…æ–°æ£®æ—", bg: "#f0fdf4", primary: "#16a34a", text: "#064e3b", card: "#ffffff" },
        { name: "ç¥ç§˜å¹»ç´«", bg: "#faf5ff", primary: "#9333ea", text: "#581c87", card: "#ffffff" }
    ];

    function applyTheme(index, btnElement) {
        const t = themes[index];
        state.colors = { ...t };
        
        // æ›´æ–°è¼¸å…¥æ¡†
        document.getElementById('setting-bg-color').value = t.bg;
        document.getElementById('setting-main-color').value = t.primary;
        document.getElementById('setting-text-color').value = t.text;
        
        // UI ç‹€æ…‹æ›´æ–°
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        // æ¸…é™¤èƒŒæ™¯åœ– (å› ç‚ºé¸æ“‡äº†ä¸»é¡Œè‰²)
        clearBgImage();
        
        updateUI();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) {
            showAlert("âš ï¸ åœ–ç‰‡å¤§å°è¶…é 2MBï¼Œå¯èƒ½æœƒå½±éŸ¿ç¶²é æ•ˆèƒ½ï¼Œå»ºè­°å£“ç¸®å¾Œå†ä¸Šå‚³ã€‚");
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            document.body.style.backgroundImage = `url('${e.target.result}')`;
            // ç§»é™¤ç›®å‰é¸ä¸­çš„ä¸»é¡Œæ¨£å¼ï¼Œå› ç‚ºå·²ç¶“è‡ªè¨‚èƒŒæ™¯
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        };
        reader.readAsDataURL(file);
    }

    function clearBgImage() {
        document.body.style.backgroundImage = 'none';
        document.getElementById('bg-upload').value = '';
    }

    function updateUI() {
        state.title = document.getElementById('setting-title').value;
        // å¦‚æœä½¿ç”¨è€…æ‰‹å‹•æ”¹é¡è‰²ï¼Œæ›´æ–° state
        state.colors.bg = document.getElementById('setting-bg-color').value;
        state.colors.primary = document.getElementById('setting-main-color').value;
        state.colors.text = document.getElementById('setting-text-color').value;
        state.soundEnabled = document.getElementById('setting-sound').checked;

        // æ‡‰ç”¨ CSS è®Šæ•¸
        document.getElementById('main-title').innerText = state.title;
        document.body.style.setProperty('--main-bg-color', state.colors.bg);
        document.body.style.setProperty('--primary-color', state.colors.primary);
        document.body.style.setProperty('--text-color', state.colors.text);
        document.body.style.setProperty('--card-bg', state.colors.card);
        
        document.querySelector('.stage').style.borderColor = state.colors.primary;
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        const content = document.getElementById(tabId);
        if (content) content.classList.add('active');

        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => {
            const onClickAttr = btn.getAttribute('onclick');
            if (onClickAttr && onClickAttr.includes(tabId)) {
                btn.classList.add('active');
            }
        });
    }

    function showSubMode(mode) {
        document.querySelectorAll('.import-mode').forEach(el => el.style.display = 'none');
        document.getElementById('mode-' + mode).style.display = 'block';
    }

    // --- çé …ç®¡ç† ---
    function renderPrizeInputs() {
        const container = document.getElementById('prize-list-settings');
        container.innerHTML = '';
        state.prizes.forEach((prize, index) => {
            const div = document.createElement('div');
            div.className = 'prize-row';
            div.innerHTML = `
                <span style="font-weight:bold; color:#999; width:20px;">${index+1}.</span>
                <input type="text" class="form-control" value="${prize.name}" placeholder="çé …åç¨±" oninput="updatePrizeData(${index}, 'name', this.value)">
                <input type="number" class="form-control" value="${prize.count}" placeholder="æ•¸é‡" oninput="updatePrizeData(${index}, 'count', this.value)">
                <button class="btn-icon" onclick="removePrizeRow(${index})" title="åˆªé™¤">âœ•</button>
            `;
            container.appendChild(div);
        });
    }
    function addPrizeInputRow() {
        state.prizes.push({ name: "æ–°çé …", count: 1, winners: [] });
        renderPrizeInputs();
    }
    function removePrizeRow(index) {
        showConfirm("ç¢ºå®šåˆªé™¤æ­¤çé …ï¼Ÿå·²ç”¢ç”Ÿçš„ä¸­çåå–®ä¹Ÿæœƒæ¶ˆå¤±å–”ï¼", () => {
             state.prizes.splice(index, 1);
             renderPrizeInputs();
        });
    }
    function updatePrizeData(index, field, value) {
        if (field === 'count') value = parseInt(value) || 1;
        state.prizes[index][field] = value;
    }
    function parsePrizeInputs() {
        let found = false;
        for(let i=0; i<state.prizes.length; i++) {
            if (state.prizes[i].winners.length < state.prizes[i].count) {
                state.currentPrizeIndex = i;
                found = true;
                break;
            }
        }
        if (!found) state.currentPrizeIndex = state.prizes.length; 
    }

    // --- åå–®åŒ¯å…¥é‚è¼¯ ---
    function setNames(list) {
        const uniqueSet = new Set(list.map(n => n.trim()).filter(n => n));
        const uniqueList = Array.from(uniqueSet);
        const duplicateCount = list.length - uniqueList.length;

        if (uniqueList.length === 0) {
            showAlert("åå–®æ˜¯ç©ºçš„ï¼");
            return;
        }

        if (duplicateCount > 0) {
             document.getElementById('sys-dialog-title').innerText = "é‡è¤‡åå–®è™•ç†";
             document.getElementById('sys-dialog-msg').innerText = `åµæ¸¬åˆ° ${duplicateCount} ç­†é‡è¤‡è³‡æ–™ï¼Œæ˜¯å¦è‡ªå‹•ç§»é™¤ï¼Ÿ`;
             
             const btnCancel = document.getElementById('sys-btn-cancel');
             const btnConfirm = document.getElementById('sys-btn-confirm');
             btnCancel.style.display = 'block';
             btnCancel.innerText = "ä¿ç•™é‡è¤‡"; 
             btnConfirm.innerText = "ç§»é™¤é‡è¤‡";

             const newConfirm = btnConfirm.cloneNode(true);
             btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
             const newCancel = btnCancel.cloneNode(true);
             btnCancel.parentNode.replaceChild(newCancel, btnCancel);

             newConfirm.onclick = function() {
                 state.namePool = uniqueList;
                 finalizeNameSet();
                 closeSystemDialog();
                 resetDialogButtons();
             };
             newCancel.onclick = function() {
                 state.namePool = list; 
                 finalizeNameSet();
                 closeSystemDialog();
                 resetDialogButtons();
             };

             document.getElementById('system-dialog').classList.add('active');
        } else {
            state.namePool = uniqueList;
            finalizeNameSet();
        }
    }

    function resetDialogButtons() {
        document.getElementById('sys-btn-cancel').innerText = "å–æ¶ˆ";
        document.getElementById('sys-btn-confirm').innerText = "ç¢ºå®š";
    }

    function finalizeNameSet() {
        showAlert(`âœ… åå–®æ›´æ–°æˆåŠŸï¼ç›®å‰å…±æœ‰ ${state.namePool.length} äººå¾…æŠ½ã€‚`);
        updateStageInfo();
        closeSettings();
        document.getElementById('names-input').value = state.namePool.join('\n');
    }

    // Mode A: æ‰‹å‹•
    function processManualNames() {
        const raw = document.getElementById('names-input').value;
        const list = raw.split(/[,\n]/);
        setNames(list);
    }

    // Mode B & C: ç¶²è·¯åŒ¯å…¥
    async function importFromSheet(type) {
        let url, colName;
        if (type === 'shared') {
            const inputUrl = document.getElementById('sheet-url-b').value;
            const sheetName = document.getElementById('sheet-name-b').value || 'å·¥ä½œè¡¨1';
            colName = document.getElementById('col-name-b').value;
            const match = inputUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) return showAlert("ç¶²å€æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯ Google è©¦ç®—è¡¨ç¶²å€");
            const id = match[1];
            url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        } else {
            url = document.getElementById('sheet-url-c').value;
            colName = document.getElementById('col-name-c').value;
            if (!url) return showAlert("è«‹è¼¸å…¥ CSVç¶²å€");
        }

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("ç„¡æ³•è®€å–ï¼Œè«‹ç¢ºèªæ¬Šé™æ˜¯å¦ç‚ºã€Œå…¬é–‹ã€");
            const text = await res.text();
            parseCSVAndSetNames(text, colName);
        } catch (e) {
            showAlert("åŒ¯å…¥å¤±æ•—ï¼š" + e.message);
        }
    }

    function parseCSVAndSetNames(csvText, targetColName) {
        const rows = csvText.split(/\r?\n/);
        if (rows.length < 2) return showAlert("CSV å…§å®¹ä¼¼ä¹æ˜¯ç©ºçš„æˆ–æ˜¯æ ¼å¼éŒ¯èª¤");
        const headers = rows[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
        const colIndex = headers.indexOf(targetColName.trim());
        if (colIndex === -1) {
            return showAlert(`æ‰¾ä¸åˆ°æ¨™é¡Œç‚ºã€Œ${targetColName}ã€çš„æ¬„ä½ã€‚\nåµæ¸¬åˆ°çš„æ¬„ä½ï¼š${headers.join(', ')}`);
        }
        const names = [];
        for (let i = 1; i < rows.length; i++) {
            let rowData = rows[i];
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; 
            const cols = rowData.split(regex).map(c => c.replace(/^"|"$/g, '').trim());
            if (cols[colIndex]) {
                names.push(cols[colIndex]);
            }
        }
        setNames(names);
    }

    // --- æŠ½çèˆ‡èˆå°é‚è¼¯ ---

    // æŒ‰éˆ•å‹•æ…‹æ–‡å­—è³‡æ–™åº« (ä¿®æ”¹ç‚ºæ›´å…·æ‡¸å¿µçš„èªå¥)
    const blessingWords = [
        "çè½èª°å®¶ï¼Ÿ", "å°±æ˜¯ä½ å®¶ï¼Ÿ", "å¹¸é‹å…’æ˜¯ä½ å—ï¼Ÿ", "æº–å‚™å¥½å°–å«äº†å—ï¼Ÿ", 
        "ä¸‹ä¸€å€‹å°±æ˜¯ä½ ï¼", "åˆ¥æ‡·ç–‘ï¼Œå°±æ˜¯ä½ ï¼", "å¹¸é‹å¥³ç¥é™è‡¨ï¼Ÿ", "çœ‹éä¾†ï¼Œå¤§çåœ¨é€™ï¼", 
        "å¿ƒè·³åŠ é€Ÿæ™‚åˆ»", "æ˜¯ä½ å—ï¼Ÿæ˜¯ä½ å—ï¼Ÿ", "å¤§çå¾—ä¸»æ˜¯...", "è¦‹è­‰å¥‡è¹Ÿçš„æ™‚åˆ»"
    ];

    function getRandomBlessing() {
        return blessingWords[Math.floor(Math.random() * blessingWords.length)];
    }

    function updateStageInfo() {
        const poolCount = state.namePool.length;
        document.getElementById('pool-count').innerText = poolCount;
        
        // æ›´æ–°æŠ½çæŒ‰éˆ•çš„å‰ç¥¥è©±
        const drawOneBtn = document.getElementById('btn-draw-one');
        if (!state.isRolling) {
            drawOneBtn.innerHTML = `<span>ğŸ²</span> ${getRandomBlessing()}`;
        }

        if (state.currentPrizeIndex >= state.prizes.length) {
            document.getElementById('current-prize-display').innerText = "ğŸ‰ æ´»å‹•åœ“æ»¿çµæŸ ğŸ‰";
            document.getElementById('rolling-box').innerText = "æ„Ÿè¬åƒèˆ‡";
            toggleButtons(false);
            return;
        }
        const currentPrize = state.prizes[state.currentPrizeIndex];
        const left = currentPrize.count - currentPrize.winners.length;
        document.getElementById('current-prize-display').innerHTML = 
            `æ­£åœ¨æŠ½é¸ï¼š<span>${currentPrize.name}</span> (å°šç¼º ${left} å)`;
        toggleButtons(poolCount > 0 && left > 0);
    }

    function toggleButtons(enable) {
        const btns = ['btn-draw-one', 'btn-draw-all'];
        btns.forEach(id => {
            const btn = document.getElementById(id);
            btn.disabled = !enable || state.isRolling;
        });
        document.getElementById('btn-bonus').disabled = state.isRolling;
    }

    function startDraw(mode) {
        if (state.namePool.length === 0) return showAlert("åå–®æ²’äººå•¦ï¼");
        if (state.isRolling) return;

        state.isRolling = true;
        toggleButtons(false);

        // é–å®šæŒ‰éˆ•æ–‡å­—é¿å…è®Šå‹•
        document.getElementById('btn-draw-one').innerHTML = `<span>ğŸ²</span> æŠ½çä¸­...`;

        if (state.soundEnabled) {
            audioWin.pause(); audioWin.currentTime = 0;
            audioRoll.play();
        }

        const box = document.getElementById('rolling-box');
        rollInterval = setInterval(() => {
            const rand = Math.floor(Math.random() * state.namePool.length);
            box.innerText = state.namePool[rand];
        }, 50);

        setTimeout(() => {
            stopDraw(mode);
        }, 2000); 
    }

    function stopDraw(mode) {
        clearInterval(rollInterval);
        state.isRolling = false;

        if (state.soundEnabled) {
            audioRoll.pause(); audioRoll.currentTime = 0;
            audioWin.play();
        }

        fireConfetti();

        const currentPrize = state.prizes[state.currentPrizeIndex];
        const remainingSlots = currentPrize.count - currentPrize.winners.length;
        
        let drawCount = 1;
        if (mode === 'all') {
            drawCount = remainingSlots;
            if (state.namePool.length < drawCount) drawCount = state.namePool.length;
        }

        const newWinners = [];
        for(let i=0; i<drawCount; i++) {
            const randIndex = Math.floor(Math.random() * state.namePool.length);
            const winner = state.namePool.splice(randIndex, 1)[0];
            newWinners.push(winner);
        }

        currentPrize.winners.push(...newWinners);

        const box = document.getElementById('rolling-box');
        if (newWinners.length === 1) {
            box.innerText = newWinners[0];
            box.style.color = "var(--accent-color)";
        } else {
            box.innerText = `ğŸ‰ æ­å–œ ${newWinners.length} ä½å¾—ä¸»ï¼`;
            box.style.color = "var(--accent-color)";
        }

        renderWinnersArea();

        if (currentPrize.winners.length >= currentPrize.count) {
            state.currentPrizeIndex++;
        }

        setTimeout(() => {
            box.style.color = "var(--primary-color)";
            updateStageInfo();
        }, 3000);
    }

    function renderWinnersArea() {
        const container = document.getElementById('winners-container');
        container.innerHTML = '';
        state.prizes.forEach((prize, pIndex) => {
            if (prize.winners.length === 0) return;
            const group = document.createElement('div');
            group.className = 'prize-group';
            group.innerHTML = `<h3>${prize.name} <span>(${prize.winners.length}/${prize.count})</span></h3>`;
            const ul = document.createElement('ul');
            ul.className = 'winner-list';
            [...prize.winners].reverse().forEach((winnerName, reverseIndex) => {
                const realIndex = prize.winners.length - 1 - reverseIndex;
                const li = document.createElement('li');
                li.className = 'winner-item';
                li.innerHTML = `
                    <span class="winner-name">ğŸ† ${winnerName}</span>
                    <button class="redraw-btn" title="ç¼ºå¸­/é‡æŠ½" onclick="reDraw(${pIndex}, ${realIndex}, '${winnerName}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                `;
                ul.appendChild(li);
            });
            group.appendChild(ul);
            container.appendChild(group);
        });
    }

    // --- ä¿®æ”¹å¾Œçš„è£œæŠ½é‚è¼¯ ---
    function reDraw(pIndex, wIndex, name) {
        showConfirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${name}ã€çš„ä¸­çè³‡æ ¼å—ï¼Ÿ\nè©²å“¡å°‡è¢«è¦–ç‚ºç¼ºå¸­ï¼Œåé¡å°‡é‡‹å‡ºä¾›é‡æ–°æŠ½çã€‚`, () => {
            // 1. ç§»é™¤è©²ä¸­çè€…
            state.prizes[pIndex].winners.splice(wIndex, 1);
            
            // 2. é‡æ–°è¨ˆç®—ç›®å‰è©²æŠ½å“ªå€‹ç (å› ç‚ºè©²çé …åé¡æœªæ»¿ï¼Œæœƒè®Šå›ç›®å‰é€²åº¦)
            parsePrizeInputs();
            
            // 3. æ›´æ–°ä»‹é¢
            renderWinnersArea();
            updateStageInfo();
            
            // 4. æç¤ºä¸»æŒäºº
            showAlert(`å·²é‡‹å‡ºã€Œ${state.prizes[pIndex].name}ã€çš„ä¸€å€‹åé¡ï¼\nè«‹æŒ‰ä¸‹ä¸»ç•«é¢çš„æŠ½çæŒ‰éˆ•ä¾†è£œæŠ½ã€‚`);
        });
    }

    function openBonusModal() { document.getElementById('bonus-modal').classList.add('active'); }
    function closeBonusModal() { document.getElementById('bonus-modal').classList.remove('active'); }
    
    function confirmBonus() {
        const name = document.getElementById('bonus-name').value;
        const count = parseInt(document.getElementById('bonus-count').value);
        if (!name || count <= 0) return showAlert("è¼¸å…¥æœ‰èª¤");

        state.prizes.splice(state.currentPrizeIndex, 0, {
            name: name, count: count, winners: []
        });

        closeBonusModal();
        showAlert(`ğŸ å·²åŠ ç¢¼ã€Œ${name}ã€ï¼`);
        renderPrizeInputs(); 
        updateStageInfo();
    }

    function saveTemplate() {
        const template = {
            title: state.title,
            colors: state.colors,
            soundEnabled: state.soundEnabled,
            prizes: state.prizes.map(p => ({ name: p.name, count: p.count, winners: [] }))
        };
        localStorage.setItem('luckyDrawTemplate', JSON.stringify(template));
        document.getElementById('template-msg').innerText = "âœ… ç¯„æœ¬å·²å„²å­˜ (åŒ…å«æ¨™é¡Œã€é…è‰²ã€çé …è¨­å®š)";
        setTimeout(() => document.getElementById('template-msg').innerText = "", 3000);
    }

    function loadTemplate() {
        const raw = localStorage.getItem('luckyDrawTemplate');
        if (!raw) return showAlert("æ‰¾ä¸åˆ°å„²å­˜çš„ç¯„æœ¬");
        
        showConfirm("ç¢ºå®šè¼‰å…¥ç¯„æœ¬ï¼Ÿç›®å‰çš„çé …è¨­å®šå°‡è¢«è¦†è“‹ (å·²ç”¢ç”Ÿçš„ä¸­çåå–®æœƒæ¸…ç©º)", () => {
             try {
                const template = JSON.parse(raw);
                state.title = template.title;
                state.colors = template.colors;
                state.soundEnabled = template.soundEnabled;
                state.prizes = template.prizes;
                state.currentPrizeIndex = 0; 
                
                document.getElementById('setting-title').value = state.title;
                document.getElementById('setting-bg-color').value = state.colors.bg;
                document.getElementById('setting-main-color').value = state.colors.primary;
                if(state.colors.text) document.getElementById('setting-text-color').value = state.colors.text;
                document.getElementById('setting-sound').checked = state.soundEnabled;
                
                // æ¸…é™¤èƒŒæ™¯åœ–ä»¥æ‡‰ç”¨ç¯„æœ¬é¡è‰²
                clearBgImage();

                updateUI();
                renderPrizeInputs();
                renderWinnersArea();
                updateStageInfo();
                
                showAlert("ç¯„æœ¬è¼‰å…¥æˆåŠŸï¼");
            } catch(e) {
                showAlert("ç¯„æœ¬è®€å–éŒ¯èª¤");
            }
        });
    }
    
    function clearTemplate() {
        showConfirm("ç¢ºå®šæ¸…é™¤å„²å­˜çš„ç¯„æœ¬ï¼Ÿ", () => {
            localStorage.removeItem('luckyDrawTemplate');
            showAlert("å·²æ¸…é™¤");
        });
    }

    // --- æˆªåœ–èˆ‡åŒ¯å‡ºåŠŸèƒ½ ---
    function saveScreenshot() {
        // å»ºç«‹ä¸€å€‹è‡¨æ™‚å®¹å™¨ä¾†ç”¢ç”Ÿæˆªåœ–
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.top = '0';
        tempContainer.style.left = '0';
        tempContainer.style.width = '100%';
        tempContainer.style.zIndex = '-9999';
        
        // ä¿®æ­£ï¼šä½¿ç”¨æœ€å¼·çƒˆçš„ç™½åº•é»‘å­—å°æ¯”
        tempContainer.style.backgroundColor = '#ffffff'; 
        tempContainer.style.backgroundImage = 'none'; 
        tempContainer.style.color = '#000000';
        tempContainer.style.fontFamily = "'Microsoft JhengHei', 'Segoe UI', sans-serif"; // ç¢ºä¿ä¸­æ–‡å­—é«”æ¸…æ™°
        
        tempContainer.style.padding = '40px 30px'; 
        tempContainer.style.display = 'flex';
        tempContainer.style.flexDirection = 'column';
        tempContainer.style.alignItems = 'center';

        // 1. è¤‡è£½æ¨™é¡Œ (H1)
        const originalTitle = document.getElementById('main-title');
        const titleClone = originalTitle.cloneNode(true);
        titleClone.style.marginBottom = '30px';
        titleClone.style.fontSize = '3rem'; // å­—é«”åŠ å¤§
        titleClone.style.fontWeight = '900'; // å­—é«”åŠ åˆ°æœ€ç²—
        titleClone.style.color = '#000000'; // ç´”é»‘
        titleClone.style.textShadow = 'none'; 
        tempContainer.appendChild(titleClone);

        // 2. è¤‡è£½ä¸­çåå–® (Winners)
        const originalWinners = document.getElementById('winners-container');
        const winnersClone = originalWinners.cloneNode(true);
        
        winnersClone.style.display = 'grid'; 
        winnersClone.style.width = '100%';
        winnersClone.style.maxWidth = '1000px'; 
        winnersClone.style.gap = '20px'; // å¢åŠ é–“è·
        
        // é‡å°æˆªåœ–å…§çš„å¡ç‰‡é€²è¡Œã€Œé«˜å¼·åº¦ã€æ¨£å¼å¼·åŒ–
        const cards = winnersClone.querySelectorAll('.prize-group');
        cards.forEach(card => {
            // æ”¹ç‚ºç´”ç™½åº•ã€ç²—é»‘æ¡†
            card.style.backgroundColor = '#ffffff'; 
            card.style.border = '3px solid #000000'; // åŠ ç²—ç´”é»‘é‚Šæ¡†
            card.style.boxShadow = 'none';
            card.style.color = '#000000';
            card.style.borderRadius = '8px';
            
            // å¼·åŒ–çé …æ¨™é¡Œ
            const header = card.querySelector('h3');
            if (header) {
                header.style.color = '#000000'; // ç´”é»‘
                header.style.borderBottom = '3px solid #000000'; // åŠ ç²—ç´”é»‘åˆ†éš”ç·š
                header.style.fontSize = '1.8rem'; // å­—é«”åŠ å¤§
                header.style.fontWeight = '800'; // åŠ ç²—
                header.style.paddingBottom = '10px';
                header.style.marginBottom = '10px';
            }

            // å¼·åŒ–åå–®æ–‡å­—
            const items = card.querySelectorAll('.winner-item');
            items.forEach(item => {
                item.style.color = '#000000'; // ç´”é»‘
                item.style.fontWeight = '700'; // åŠ ç²—
                item.style.borderBottom = '1px solid #555555'; // æ·±ç°åˆ†éš”ç·š
                item.style.fontSize = '1.4rem'; // å­—é«”åŠ å¤§
                item.style.padding = '12px 0';
            });

            // ç§»é™¤æˆªåœ–ä¸­çš„é‡æŠ½æŒ‰éˆ•
            card.querySelectorAll('.redraw-btn').forEach(btn => btn.remove());
        });
        
        tempContainer.appendChild(winnersClone);

        // å°‡è‡¨æ™‚å®¹å™¨åŠ å…¥ Body
        document.body.appendChild(tempContainer);

        // ä½¿ç”¨ html2canvas æˆªåœ–
        html2canvas(tempContainer, {
            useCORS: true, 
            scale: 2, // é«˜è§£æåº¦
            backgroundColor: '#ffffff'
        }).then(canvas => {
            document.body.removeChild(tempContainer);

            canvas.toBlob(function(blob) {
                if (!blob) return;

                const link = document.createElement('a');
                link.download = `ä¸­çåå–®_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();

                try {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        const item = new ClipboardItem({ "image/png": blob });
                        navigator.clipboard.write([item]).then(() => {
                            showAlert("ğŸ“¸ æˆªåœ–å·²ä¸‹è¼‰ï¼Œä¸¦æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n(å·²å¢å¼·æ–‡å­—æ·±åº¦èˆ‡æ¸…æ™°åº¦)");
                        }).catch(err => {
                            showAlert("ğŸ“¸ æˆªåœ–å·²ä¸‹è¼‰ï¼\n(è‡ªå‹•è¤‡è£½åŠŸèƒ½è¢«ç€è¦½å™¨é˜»æ“‹)");
                        });
                    } else {
                        showAlert("ğŸ“¸ æˆªåœ–å·²ä¸‹è¼‰ï¼");
                    }
                } catch (e) {
                    showAlert("ğŸ“¸ æˆªåœ–å·²ä¸‹è¼‰ï¼");
                }
            }, 'image/png');
        });
    }

    function exportCSV() {
        let csvContent = "\uFEFF"; // BOM for Excel encoding
        csvContent += "çé …,ä¸­çè€…\n";
        
        state.prizes.forEach(prize => {
            prize.winners.forEach(winner => {
                // è™•ç† CSV æ ¼å¼ï¼Œé¿å…åå­—ä¸­æœ‰é€—è™Ÿ
                const safeName = winner.includes(',') ? `"${winner}"` : winner;
                csvContent += `${prize.name},${safeName}\n`;
            });
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        
        // ç”¢ç”Ÿæª”åï¼šæ´»å‹•ä¸»æ¨™é¡Œ-ä¸­çåå–®-æ—¥æœŸ-æ™‚é–“
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        const timeStr = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
        // ç§»é™¤æ¨™é¡Œä¸­ä¸é©åˆåšæª”åçš„å­—å…ƒ
        const safeTitle = state.title.replace(/[\\/:*?"<>|]/g, '');
        
        link.setAttribute("download", `${safeTitle}-ä¸­çåå–®-${dateStr}-${timeStr}.csv`);
        
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function fireConfetti() {
        var count = 200;
        var defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
            confetti(Object.assign({}, defaults, opts, {
                particleCount: Math.floor(count * particleRatio)
            }));
        }
        fire(0.25, { spread: 26, startVelocity: 55 });
        fire(0.2, { spread: 60 });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
        fire(0.1, { spread: 120, startVelocity: 45 });
    }
</script>
</body>
</html>